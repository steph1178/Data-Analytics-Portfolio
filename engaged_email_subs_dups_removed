WITH email_engaged as
    (SELECT user_id 
     FROM
         (SELECT user_id,
          ROW_NUMBER() OVER (PARTITION BY user_id order by user_id) as row
          FROM pages
          WHERE timestamp >= CURRENT_DATE - 90
          AND user_id IS NOT NULL) a
    JOIN national_subscribers ON user_id = visitor_id
    WHERE  a.row = 1
    GROUP BY 1
    ORDER BY random()
    LIMIT 256801*0.35 ),

email_unegaged as (
     SELECT visitor_id
     FROM
          (SELECT visitor_id,
          RANK() OVER (PARTITION BY visitor_id) as rank
          FROM national_subscribers) b
     JOIN javascript.pages ON visitor_id = user_id
     WHERE user_id NOT IN (
         SELECT user_id
         FROM nat_engaged
         )
     AND b.rank = 1
     GROUP BY 1
     ORDER BY random()
     LIMIT 210120 ) ,

combined AS (
     SELECT user_id::BIGINT FROM email_engaged
     UNION
     SELECT visitor_id FROM email_unengaged
     GROUP BY 1)

SELECT *
FROM national_subscribers
WHERE visitor_id IN (
        SELECT user_id
        FROM combined
    )
